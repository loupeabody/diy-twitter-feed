<!doctype html>
<html lang="en">
	<head>
		<title>Twitter API</title>
		<link rel="stylesheet" href="styles/style.css">
		<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,600,700,900" rel="stylesheet" type="text/css">
	</head>
	<body>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
		<script id="main-template" type="text/x-handlebars-template">
			<section class="tweets">
				{{#each tweets}}
					{{> tweetTemplate this}}
				{{~/each}}
			</section>
		</script>
		<script id="tweet-template" type="text/x-handlebars-template">
			<div class="tweet cf">
				<p class="tweet-body">{{{addEntitiesToBody text entities}}}</p>
				<p class="tweet-author">
					{{name}}&nbsp;
					<span class="tweet-username">
						(<a href="https://twitter.com/{{username}}">@{{username}}</a>)
					</span></p>
				<p class="tweet-time">
					<a href="https://twitter.com/{{username}}/status/{{id}}">{{ts}}</a>
				</p>
			</div>
		</script>
		<script type="text/javascript">
			var tweetTemplateSource = document.getElementById('tweet-template').innerHTML,
					mainTemplateSource = document.getElementById('main-template').innerHTML,
					mainTemplate = Handlebars.compile(mainTemplateSource),
					tweetTemplate = Handlebars.compile(tweetTemplateSource),
					locals = { users: [], terms: [], tweets: [] }

			Handlebars.registerPartial('tweetTemplate',tweetTemplate)
			Handlebars.registerHelper('addEntitiesToBody',function(body, entities) {
				var newBody = body
				if (entities.urls.length > 0) {
					entities.urls.forEach(function(u) {
						newBody = newBody.replace(u.url,"<a href=\""+u.url+"\">"+u.url+"</a>")
					})
				}
				if (entities.media != undefined && entities.media.length > 0) {
					entities.media.forEach(function(u) {
						newBody = newBody.replace(u.url,"<a href=\""+u.url+"\">"+u.url+"</a>")
					})
				}
				if (entities["user_mentions"].length > 0) {
					entities["user_mentions"].forEach(function(u) {
						newBody = newBody.replace("\@"+u["screen_name"],"<a href=\"https://twitter.com/"+u["screen_name"].toLowerCase()+"\">\@"+u["screen_name"]+"</a>")
					})
				}
				if (entities.hashtags.length > 0) {
					entities.hashtags.forEach(function(u) {
						newBody = newBody.replace("\#"+u.text,"<a href=\"https://twitter.com/hashtag/"+u.text+"\">\#"+u.text+"</a>")
					})
				}
				console.log(newBody)
				return new Handlebars.SafeString(newBody)
			})

			function makeRequest(method, url) {
				return new Promise(function(resolve,reject) {
					var xhr = new XMLHttpRequest()
					xhr.addEventListener('error', reject)
					xhr.addEventListener('load', resolve)
					xhr.open(method, url)
					xhr.send()
				})
			}

			function getTwitterOAuthToken() { return makeRequest("GET", window.location.origin + "/token") }
			function getUserTweets(token,usn) { return makeRequest("GET", window.location.origin + "/tweets/"+encodeURIComponent(token)+"/"+usn) }

			function addTweetsToLocals(usn) {
				return getTwitterOAuthToken()
					.then(function(r) {
						var token = JSON.parse(r.currentTarget.response)["token"]
						return getUserTweets(token,usn)
					})
					.then(function(r) {
						console.log(JSON.parse(r.currentTarget.response))
						var tweets = JSON.parse(r.currentTarget.response)
						tweets.map(function(t) {
							locals.tweets.push(t)
						})
					})
					.then(function(r) { document.body.innerHTML += mainTemplate(locals)})
					.catch(function(err) { console.log(err) })
			}
		</script>
	</body>
</html>